<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artist Admin Dashboard</title>

<link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
<link rel="manifest" href="images/favicons/site.webmanifest">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Your HTML and scripts here -->

<!-- Bootstrap Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<link rel="stylesheet" href="admin/style.css">

<style>
body { font-family: 'Inter', sans-serif; background: #f7f9fc; }
.sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 250px; background: #1a1a2e; color: #fff; padding-top: 20px; }
.sidebar a { display: block; padding: 12px 20px; color: #fff; text-decoration: none; border-left: 4px solid transparent; transition: 0.3s; margin-bottom: 4px; border-radius: 4px; }
.sidebar a.active, .sidebar a:hover { background: #162447; border-left: 4px solid #e43f5a; }
.sidebar h4 { font-weight: 600; letter-spacing: 1px; margin-bottom: 20px; }

main { margin-left: 270px; padding: 40px 30px; }
header { background: #fff; padding: 15px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
footer { background: #fff; padding: 20px 30px; text-align: center; color: #555; margin-top: 50px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

.card { border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
.btn { border-radius: 8px; }
input, textarea { border-radius: 8px; }
hr { border-top: 1px solid #eee; }
.help-icon { cursor: pointer; font-size: 16px; }
.sortable .draggable { background: #f9f9f9; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; gap:8px; flex-wrap: wrap; align-items: center; }
.file-input-wrapper { display:flex; gap:8px; align-items:center; }
.file-input-wrapper img { height:50px; width:50px; object-fit:cover; border-radius:6px; }
</style>

</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h4 class="text-center">üéõ Admin</h4>
  <a href="#" class="active" data-section="general">üé§ General Info</a>
  <a href="#" data-section="albums">üíø Albums</a>
  <a href="#" data-section="videos">üé¨ Videos</a>
  <a href="#" data-section="events">üìÖ Events</a>
  <a href="#" data-section="socials">üåç Social Links</a>
  <a href="#" data-section="gallery">üñº Image Gallery</a>
  <a href="#" data-section="contacts">üåç Contacts</a>
  <a href="#" id="logoutBtn">üö™ Logout</a>
</div>

<main>
  <header>
    <h1 id="sectionTitle">General Info</h1>
    <div>Welcome, Admin üéµ</div>
  </header>

  <!-- Login -->
  <div id="loginSection" class="card p-5" style="max-width:400px; margin:auto;">
    <h3 class="mb-4 text-center">Admin Login</h3>
    <input id="phoneInput" type="tel" class="form-control mb-3" placeholder="+1 555 123 4567" />
    <div id="recaptcha-container" class="mb-3"></div>
    <button id="sendCodeBtn" class="btn btn-primary w-100 mb-3">Send Code</button>
    <input id="codeInput" type="text" class="form-control mb-3" placeholder="Enter verification code" />
    <button id="verifyCodeBtn" class="btn btn-success w-100 mb-4">Verify & Login</button>
    <hr class="mb-4">
    <button id="googleLoginBtn" class="btn btn-danger w-100 d-flex align-items-center justify-content-center">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="height:20px; margin-right:10px;">
      Login with Google
    </button>
  </div>

  <!-- Admin Section -->
  <div id="adminSection" class="d-none">

    <!-- General Info -->
    <form id="generalForm" class="card p-4 mb-4">
      <h4>General Info <span class="help-icon" data-bs-toggle="popover" data-bs-content="Set main artist details, tagline, and hero image.">‚ùî</span></h4>
      <input id="artistName" class="form-control mb-3" placeholder="Artist Name" />
      <input id="tagline" class="form-control mb-3" placeholder="Tagline" />

<!-- Quill CSS -->
<!-- Include Quill CSS in <head> -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<!-- Include Quill JS before your script, ideally before your closing </body> -->
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<!-- Rich Text Editor Container -->
<div id="bioEditor" style="height: 200px;"></div>

<!-- Hidden input to store HTML content -->
<input type="hidden" id="bio">

      <div class="mb-3">
        <label>Hero Image</label>
        <input type="hidden" id="heroImage">
        <div class="file-input-wrapper">
          <input type="file" id="heroUpload" class="form-control" accept="image/*">
          <img id="heroPreview" src="" alt="Preview">
          <button type="button" class="btn btn-danger btn-sm" id="heroRemoveBtn">Remove</button>
        </div>
      </div>
      <input id="contactEmail" class="form-control mb-3" placeholder="Contact Email" />
      <input id="contactNumber" class="form-control mb-3" placeholder="Contact Number" />

      <button class="btn btn-success w-100">Save Changes</button>
    </form>

    <!-- Albums -->
    <form id="albumsForm" class="card p-4 mb-4 d-none">
      <h4>Albums <span class="help-icon" data-bs-toggle="popover" data-bs-content="Add album cover, title, and link.">‚ùî</span></h4>
      <div id="albumsList" class="sortable"></div>
      <button type="button" class="btn btn-outline-primary mt-3" id="addAlbumBtn">+ Add Album</button>
      <button type="submit" class="btn btn-success mt-2 w-100">Save Albums</button>
    </form>

    <!-- Videos -->
    <form id="videosForm" class="card p-4 mb-4 d-none">
      <h4>Videos <span class="help-icon" data-bs-toggle="popover" data-bs-content="Upload MP4 or embed links.">‚ùî</span></h4>
      <div id="videosList" class="sortable"></div>
      <button type="button" class="btn btn-outline-primary mt-3" id="addVideoBtn">+ Add Video</button>
      <button type="submit" class="btn btn-success mt-2 w-100">Save Videos</button>
    </form>

    <!-- Events -->
    <form id="eventsForm" class="card p-4 mb-4 d-none">
      <h4>Events <span class="help-icon" data-bs-toggle="popover" data-bs-content="Add event title, date, venue, flyer.">‚ùî</span></h4>
      <div id="eventsList" class="sortable"></div>
      <button type="button" class="btn btn-outline-primary mt-3" id="addEventBtn">+ Add Event</button>
      <button type="submit" class="btn btn-success mt-2 w-100">Save Events</button>
    </form>

    <!-- Socials -->
    <form id="socialsForm" class="card p-4 mb-4 d-none">
      <h4>Social Links <span class="help-icon" data-bs-toggle="popover" data-bs-content="Enter links for Spotify, Instagram, etc.">‚ùî</span></h4>
      <div id="socialsList" class="sortable"></div>
      <button type="button" class="btn btn-outline-primary mt-3" id="addSocialBtn">+ Add Social</button>
      <button type="submit" class="btn btn-success mt-2 w-100">Save Social Links</button>
    </form>

    <!-- Gallery -->
    <form id="galleryForm" class="card p-4 mb-4 d-none">
      <h4>Image Gallery <span class="help-icon" data-bs-toggle="popover" data-bs-content="Add image URLs and captions.">‚ùî</span></h4>
      <div id="galleryList" class="sortable"></div>
      <button type="button" class="btn btn-outline-primary mt-3" id="addGalleryBtn">+ Add Gallery Block</button>
      <button type="button" class="btn btn-outline-primary mt-3" id="addImageBtn">+ Add Image</button>
      <button type="submit" class="btn btn-success mt-2 w-100">Save Gallery</button>
    </form>

        <!-- Contacts -->
<form id="contactsForm" class="card p-4 mb-4 d-none">
  <h4>Newsletter Subscribers</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Subscribed At</th>
      </tr>
    </thead>
    <tbody id="newsletterTableBody">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>
</form>


</main>

<footer class="bg-white mt-5 p-4 text-center shadow-sm rounded"> 
  <div class="mb-2">
    <a href="../" target="_blank" class="text-decoration-none text-primary fw-semibold">Home Page</a> | 
    <a href="../admin" class="text-decoration-none text-secondary">Admin Dashboard</a>
  </div>
  <div class="text-muted">
    Copyright &copy; <span id="currentYear"></span> <a href="../" target="_blank" class="text-decoration-none text-primary fw-semibold">MzSuMac.com</a><br>
    Created by <a href="https://rw-501.github.io/Portfolio/" target="_blank" class="text-decoration-none text-primary">Ron W.</a> All rights reserved.
  </div>
</footer>

<script>
document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc,getDocs, collection, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDsPKvHw4pmk_st5S7tThW3nMZCfVulW7A",
  authDomain: "mzsue-df11c.firebaseapp.com",
  projectId: "mzsue-df11c",
  storageBucket: "mzsue-df11c.firebasestorage.app",
  messagingSenderId: "524697523710",
  appId: "1:524697523710:web:0acc49354ee82350929caf",
  measurementId: "G-SXTX1JEV7H"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ===== Toast Helper =====
function showToast(msg, type="success"){
  const wrapper = document.createElement("div");
  wrapper.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
  wrapper.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  document.querySelector(".toast-container").appendChild(wrapper);
  setTimeout(()=>wrapper.remove(),4000);
}

// ===== Phone & Google Login Setup =====
let confirmationResult;

const allowedEmails = ['1988lrp@gmail.com','other@gmail.com','admin@example.com'];
const allowedPhones = ['+19725977878','+16666666666'];

function formatPhoneNumber(number){
  number = number.replace(/\D/g,'');
  if(number.length === 10) number = '+1' + number;
  if(number.length === 11 && number[0] !== '+') number = '+' + number;
  return number;
}

window.addEventListener("DOMContentLoaded", () => {
  window.recaptchaVerifier = new RecaptchaVerifier(
    document.getElementById("recaptcha-container"), { size:"normal" }, auth
  );
});

// Auto-format phone input
document.getElementById("phoneInput").addEventListener("input", (e)=>{
  let val = e.target.value.replace(/\D/g,'');
  if(val.length <=10) {
    if(val.length>=1) val='+1 '+val;
    if(val.length>6) val=val.slice(0,6)+' '+val.slice(6);
    if(val.length>10) val=val.slice(0,10)+' '+val.slice(10);
  } else val='+'+val;
  e.target.value=val;
});

// Phone login
document.getElementById("sendCodeBtn").addEventListener("click", async ()=>{
  const phone = formatPhoneNumber(document.getElementById("phoneInput").value);
  if(!allowedPhones.includes(phone)){ showToast("Unauthorized number","danger"); return; }
  try {
    confirmationResult = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
    showToast("Code sent to "+phone,"info");
  } catch(err){ showToast(err.message,"danger"); }
});
document.getElementById("verifyCodeBtn").addEventListener("click", async ()=>{
  const code = document.getElementById("codeInput").value;
  try{
    const result = await confirmationResult.confirm(code);
    if(!allowedPhones.includes(result.user.phoneNumber)){
      await signOut(auth); showToast("Unauthorized number","danger"); return;
    }
    showToast("Logged in as "+result.user.phoneNumber);
    loadAllSections();
  } catch(err){ showToast(err.message,"danger"); }
});

// Google login
const googleProvider = new GoogleAuthProvider();
document.getElementById("googleLoginBtn").addEventListener("click", async ()=>{
  try{
    const result = await signInWithPopup(auth, googleProvider);
    if(!allowedEmails.includes(result.user.email)){
      await signOut(auth); showToast("Unauthorized email","danger"); return;
    }
    showToast("Logged in as "+result.user.email);
    loadAllSections();
  } catch(err){ showToast(err.message,"danger"); }
});

// Auth state

// Call this on page load or after login
onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("loginSection").classList.add("d-none");
    document.getElementById("adminSection").classList.remove("d-none");
    loadGeneral(); 
    loadAllSections(); // <- loads everything in one call
  } else {
    document.getElementById("loginSection").classList.remove("d-none");
    document.getElementById("adminSection").classList.add("d-none");
  }
});
document.getElementById("logoutBtn").addEventListener("click",()=>signOut(auth));


// Initialize Quill
const quill = new Quill('#bioEditor', {
  theme: 'snow',
  placeholder: 'Write the artist bio here...',
  modules: {
    toolbar: [
      [{ header: [1, 2, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ list: 'ordered' }, { list: 'bullet' }],
      ['link', 'image'],
      ['clean']
    ]
  }
});

// ===== Load & Save General Info =====
async function loadGeneral() {
  const snap = await getDoc(doc(db, "siteContent", "main"));
  if (snap.exists()) {
    const d = snap.data();
    
    // Set basic inputs
    ["artistName", "tagline", "heroImage", 'contactEmail', 'contactNumber'].forEach(id => {
      if (document.getElementById(id)) document.getElementById(id).value = d[id] || "";
    });

    // Load rich text bio
    if (d.bio) quill.root.innerHTML = d.bio;

    // Load hero image preview
    if (d.heroImage) document.getElementById("heroPreview").src = d.heroImage;
  }
}

document.getElementById("generalForm").addEventListener("submit", async e => {
  e.preventDefault();
  const data = {
    artistName: document.getElementById("artistName").value,
    name: document.getElementById("artistName").value,
    tagline: document.getElementById("tagline").value,
    bio: quill.root.innerHTML, // save formatted HTML
    heroImage: document.getElementById("heroImage").value,
    contactNumber: document.getElementById("contactNumber").value,
    contactEmail: document.getElementById("contactEmail").value
    
    
  };
  await setDoc(doc(db, "siteContent", "main"), data, { merge: true });
  showToast("General info updated!");
});


// ===== Sidebar Navigation =====
document.querySelectorAll(".sidebar a[data-section]").forEach(link => {
  link.addEventListener("click", e => {
    e.preventDefault();
    document.querySelectorAll(".sidebar a").forEach(l => l.classList.remove("active"));
    link.classList.add("active");

    const sectionTitle = document.getElementById("sectionTitle");
    if (sectionTitle) sectionTitle.textContent = link.textContent.trim();

    document.querySelectorAll("#adminSection form").forEach(f => f.classList.add("d-none"));

    const targetForm = document.getElementById(link.dataset.section + "Form");
    if (targetForm) {
      targetForm.classList.remove("d-none");
    } else {
      console.warn("No form found for section:", link.dataset.section);
    }
  });
});


// ===== Dynamic Blocks & Drag/Drop =====
function enableDragSort(container){
  container.querySelectorAll(".draggable").forEach(item=>{
    item.draggable=true;
    item.addEventListener("dragstart", e=>{ item.classList.add("dragging"); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData("text/plain",""); });
    item.addEventListener("dragend", e=>{ item.classList.remove("dragging"); container.querySelector(".placeholder")?.remove(); });
    item.addEventListener("dragover", e=>{
      e.preventDefault();
      const placeholder = container.querySelector(".placeholder") || (()=>{ const ph=document.createElement("div"); ph.className="placeholder"; container.appendChild(ph); return ph; })();
      const rect = item.getBoundingClientRect();
      const next = (e.clientY - rect.top)/rect.height>0.5;
      container.insertBefore(placeholder, next?item.nextSibling:item);
    });
    item.addEventListener("drop", e=>{
      e.stopPropagation();
      const placeholder = container.querySelector(".placeholder");
      if(item!==container.querySelector(".dragging")) container.insertBefore(container.querySelector(".dragging"), placeholder);
      placeholder?.remove();
      autoSave(container.id);
    });
  });
}

// ===== File Input Helper (Multi-file support) =====
function createFileInput(container, placeholder, existingValues=[], multiple=false){
  const wrapper=document.createElement("div"); wrapper.className="d-flex flex-wrap gap-2 mb-2 draggable";
  const input=document.createElement("input"); input.type="file"; input.accept="image/*"; input.multiple=multiple; input.className="form-control";
  const hiddenInputs=[];

  const previewContainer=document.createElement("div"); previewContainer.className="d-flex flex-wrap gap-2";

  function addPreview(file,url){
    const imgWrapper=document.createElement("div"); imgWrapper.style.position="relative";
    const img=document.createElement("img"); img.src=url; img.style.width="60px"; img.style.height="60px"; img.style.objectFit="cover"; img.style.borderRadius="6px";
    const removeBtn=document.createElement("button"); removeBtn.type="button"; removeBtn.textContent="√ó"; removeBtn.style.position="absolute"; removeBtn.style.top="0"; removeBtn.style.right="0"; removeBtn.className="btn btn-sm btn-danger";
    removeBtn.addEventListener("click", ()=>{ imgWrapper.remove(); hiddenInputs.splice(hiddenInputs.indexOf(url),1); autoSave(container.id); });
    imgWrapper.append(img,removeBtn); previewContainer.appendChild(imgWrapper);
  }

  existingValues.forEach(url=>{ addPreview(null,url); hiddenInputs.push(url); });

  input.addEventListener("change", async ()=>{
    for(const file of input.files){
      const storageRef=ref(storage, `${container.id}/${file.name}`);
      await uploadBytes(storageRef,file);
      const url=await getDownloadURL(storageRef);
      addPreview(file,url); hiddenInputs.push(url);
      autoSave(container.id);
    }
    input.value="";
  });

  wrapper.append(input,previewContainer);
  container.appendChild(wrapper);
  return hiddenInputs;
}

// ===== Input Block with optional file input =====
function createInputBlock(container, placeholders, values=[], fileIndices=[]){
  const div=document.createElement("div");
  div.className="mb-2 border p-2 rounded bg-light d-flex gap-2 align-items-start flex-wrap draggable";

  placeholders.forEach((ph,i)=>{
    if(fileIndices.includes(i)){
      createFileInput(div, ph, values[i]? [values[i]] : [], false);
    } else {
      const input=document.createElement("input");

      // ‚úÖ Only Date field becomes date input
      if (ph === "Date") {
        input.type = "date"; 
      } else {
        input.type = "text"; 
      }
      input.className="form-control"; input.placeholder=ph; input.value=values[i]||"";
      input.addEventListener("input", ()=>autoSave(container.id));
      div.appendChild(input);
    }
  });

  if(!fileIndices.length){
    const removeBtn=document.createElement("button");
    removeBtn.type="button"; removeBtn.className="btn btn-danger btn-sm"; removeBtn.textContent="Remove";
    removeBtn.addEventListener("click", ()=>{ div.remove(); autoSave(container.id); });
    div.appendChild(removeBtn);
  }

  container.appendChild(div);
  enableDragSort(container);
  return div;
}



async function saveDynamicSection(containerId, docName) {
  const container = document.getElementById(containerId + "List");
  const items = [];

  container.querySelectorAll("div").forEach(div => {
    const textInputs = Array.from(div.querySelectorAll("input[type=text]")).map(i => i.value.trim());
    const hiddenInputs = Array.from(div.querySelectorAll("input[type=hidden]")).map(i => i.value.trim());

    // Take only first value from each array (no nested arrays)
    const text = textInputs[0] || "";
    const file = hiddenInputs[0] || "";

    if (text || file) {
      items.push({
        text,
        file
      });
    }
  });

  await setDoc(doc(db, "siteContent", docName), { items }, { merge: true });
  showToast(containerId + " updated!");
}



async function loadNewsletterSubscribers() {
  const tbody = document.getElementById("newsletterTableBody");
  tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

  try {
    const snap = await getDocs(collection(db, "newsletter"));
    if (snap.empty) {
      tbody.innerHTML = "<tr><td colspan='3'>No subscribers yet.</td></tr>";
      return;
    }

    let rows = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      rows += `
        <tr>
          <td>${d.name || ""}</td>
          <td>${d.email || ""}</td>
          <td>${new Date(d.subscribedAt).toLocaleString()}</td>
        </tr>
      `;
    });

    tbody.innerHTML = rows;
  } catch (err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="3" class="text-danger">Error loading subscribers</td></tr>`;
  }
}

// Load all sections
async function loadAllSections() {
  const sections = ["albums", "videos", "events", "socials", "gallery"];

  for (const sec of sections) {
    if (sec === "contacts") {
      // Special case: load subscribers table
      await loadNewsletterSubscribers();
      continue; // skip the rest of the loop for contacts
    }


    const snap = await getDoc(doc(db, "siteContent", sec));
    const items = snap.exists() ? snap.data().items || [] : [];
    const container = document.getElementById(sec + "List");
    container.innerHTML = "";

    let placeholders = [], fileIndices = [];

    switch (sec) {
      case "albums":
        placeholders = ["Album Title", "Cover Image", "Link"];
        fileIndices = [1];
        break;
      case "videos":
        placeholders = ["Video Title", "Embed URL"];
        fileIndices = [];
        break;
      case "events":
        placeholders = ["Event Name", "Date", "Venue", "Flyer Image"];
        fileIndices = [3];
        break;
      case "socials":
        placeholders = ["Platform", "URL"];
        fileIndices = [];
        break;
      case "gallery":
        placeholders = ["Image", "Caption"];
        fileIndices = [0];
        break;
    }

    items.forEach(item => {
      if (sec === "gallery") {
        // gallery needs array of URLs
        createGalleryInputBlock(container, item.files || []);
      } else {
        createInputBlock(container, placeholders, [...(item.texts || []), ...(item.files || [])], fileIndices);
      }
    });
  }

  // Load newsletter subscribers (contacts)
  await loadNewsletterSubscribers();
}


// ===== Multi-image File Input & Carousel =====
function createGalleryInputBlock(container, existingImages = []) {
  const wrapper = document.createElement("div");
  wrapper.className = "mb-2 border p-2 rounded bg-light draggable";

  // File input for new images
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.multiple = true;
  input.className = "form-control mb-2";
  wrapper.appendChild(input);

  // Carousel container
  const carouselId = "carousel" + Date.now();
  const carouselDiv = document.createElement("div");
  carouselDiv.className = "carousel slide mb-2";
  carouselDiv.id = carouselId;
  const carouselInner = document.createElement("div");
  carouselInner.className = "carousel-inner";
  carouselDiv.appendChild(carouselInner);
  wrapper.appendChild(carouselDiv);

  // Hidden input to store all image URLs
  const hiddenInput = document.createElement("input");
  hiddenInput.type = "hidden";
  wrapper.appendChild(hiddenInput);

  // Function to add images to carousel
  async function addImages(filesOrUrls) {
    for (const item of filesOrUrls) {
      let url;
      let storageRef;
      if (item instanceof File) {
        storageRef = ref(storage, `gallery/${item.name}-${Date.now()}`);
        await uploadBytes(storageRef, item);
        url = await getDownloadURL(storageRef);
      } else {
        // item is a string URL (preload)
        url = item;
      }

      const carouselItem = document.createElement("div");
      carouselItem.className = "carousel-item";

      const img = document.createElement("img");
      img.src = url;
      img.className = "d-block w-100";
      img.style.height = "150px";
      img.style.objectFit = "cover";

      carouselItem.appendChild(img);

      // Active first slide
      if (carouselInner.children.length === 0) carouselItem.classList.add("active");

      // Remove button
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "√ó";
      removeBtn.className = "btn btn-sm btn-danger position-absolute";
      removeBtn.style.top = "5px";
      removeBtn.style.right = "5px";
      removeBtn.addEventListener("click", async () => {
        // Delete from storage if it‚Äôs a newly uploaded file
        if (storageRef) await deleteObject(storageRef);
        carouselItem.remove();
        hiddenInput.value = hiddenInput.value.split(",").filter(u => u !== url).join(",");
        autoSave("gallery");
      });

      carouselItem.appendChild(removeBtn);
      carouselInner.appendChild(carouselItem);

      // Update hidden input
      const urls = hiddenInput.value ? hiddenInput.value.split(",") : [];
      urls.push(url);
      hiddenInput.value = urls.join(",");
    }
    autoSave("gallery");
  }

  input.addEventListener("change", async () => {
    await addImages(Array.from(input.files));
    input.value = "";
  });

  // Preload existing images (URLs only)
  if (existingImages.length) addImages(existingImages);

  // Remove entire block
  const removeBlockBtn = document.createElement("button");
  removeBlockBtn.type = "button";
  removeBlockBtn.className = "btn btn-danger btn-sm mt-2";
  removeBlockBtn.textContent = "Remove Block";
  removeBlockBtn.addEventListener("click", () => {
    wrapper.remove();
    autoSave("gallery");
  });
  wrapper.appendChild(removeBlockBtn);

  container.appendChild(wrapper);
  return wrapper;
}


// ===== Auto-save Gallery Section =====
async function autoSave(containerId){
  const sectionsMap = {
    albums: "albums",
    videos: "videos",
    events: "events",
    socials: "socials",
    gallery: "gallery"
  };
  if(!sectionsMap[containerId]) return;

  const container=document.getElementById(containerId+"List");
  const items=[];
  container.querySelectorAll("div.draggable").forEach(div=>{
    const vals=Array.from(div.querySelectorAll("input[type=text]")).map(i=>i.value);
    const fileUrls=Array.from(div.querySelectorAll("input[type=hidden]")).map(i=>i.value);
    const merged = vals.concat(fileUrls);
    if(merged.some(v=>v)) items.push(merged);
  });
  await setDoc(doc(db,"siteContent",sectionsMap[containerId]), {items}, {merge:true});
  showToast(containerId+" updated!");
}


// ===== Load Gallery Section =====
async function loadGallery() {
  const snap = await getDoc(doc(db, "siteContent", "gallery"));
  const container = document.getElementById("galleryList");
  container.innerHTML = "";
  const items = snap.exists() ? snap.data().items || [] : [];
  items.forEach(urls => createGalleryInputBlock(container, urls));
}


// Hero image upload
const heroUpload = document.getElementById("heroUpload");
const heroPreview = document.getElementById("heroPreview");
const heroInput = document.getElementById("heroImage");

heroUpload.addEventListener("change", async () => {
  const file = heroUpload.files[0];
  if (!file) return;

  // Upload to Firebase Storage
  const storageRef = ref(storage, `hero/${file.name}-${Date.now()}`);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  // Update preview & hidden input
  heroPreview.src = url;
  heroInput.value = url;

  showToast("Hero image uploaded!");
});

// Remove hero image
document.getElementById("heroRemoveBtn").addEventListener("click", () => {
  heroPreview.src = "";
  heroInput.value = "";
});

// ===== Add Gallery Button =====
// ===== Add Button Handlers =====
document.getElementById("addAlbumBtn").addEventListener("click", () => {
  const container = document.getElementById("albumsList");
  createInputBlock(container, ["Album Title","Cover Image","Link"], [], [1]);
});

document.getElementById("addVideoBtn").addEventListener("click", () => {
  const container = document.getElementById("videosList");
  createInputBlock(container, ["Video Title","Embed URL"]);
});

document.getElementById("addEventBtn").addEventListener("click", () => {
  const container = document.getElementById("eventsList");
  createInputBlock(container, ["Event Name","Date","Venue","Flyer Image"], [], [3]);
});

document.getElementById("addSocialBtn").addEventListener("click", () => {
  const container = document.getElementById("socialsList");
  createInputBlock(container, ["Platform","URL"]);
});

document.getElementById("addGalleryBtn").addEventListener("click", () => {
  const container = document.getElementById("galleryList");
  createGalleryInputBlock(container);
});

// (optional) if you want "+ Add Image" separate:
document.getElementById("addImageBtn").addEventListener("click", () => {
  const container = document.getElementById("galleryList");
  createInputBlock(container, ["Image URL","Caption"], [], [0]);
});


// ===== Form Save Handlers =====
document.getElementById("albumsForm").addEventListener("submit", e => {
  e.preventDefault();
  saveDynamicSection("albums", "albums");
});

document.getElementById("videosForm").addEventListener("submit", e => {
  e.preventDefault();
  saveDynamicSection("videos", "videos");
});

document.getElementById("eventsForm").addEventListener("submit", e => {
  e.preventDefault();
  saveDynamicSection("events", "events");
});

document.getElementById("socialsForm").addEventListener("submit", e => {
  e.preventDefault();
  saveDynamicSection("socials", "socials");
});

document.getElementById("galleryForm").addEventListener("submit", e => {
  e.preventDefault();
  saveDynamicSection("gallery", "gallery");
});





const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
popoverTriggerList.map(el => new bootstrap.Popover(el));

// Call loadGallery on page load
loadGallery();
</script>

</body>
</html>
